<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peeble - Connecting Hearts</title>
    <link rel="stylesheet" href="./style.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#5a67d8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Peeble">
    <meta name="description" content="Secure voice messages across languages & distances using NFC technology">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM1YTY3ZDgiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiLz4KPHN2ZyB4PSIxIiB5PSIxIiB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPgo8cGF0aCBkPSJtMTIgMTQgNC05TDQgOWw4IDMtMiA0eiIvPgo8cGF0aCBkPSJtMTIgMTcgNi0zLTYtM3YzeiIvPgo8L3N2Zz4KPC9zdmc+Cjx0ZXh0IHg9Ijk2IiB5PSIxNTYiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0OCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn5qoPC90ZXh0Pgo8L3N2Zz4K">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="./style.css" as="style">
    <link rel="preload" href="./main.js" as="script">
</head>
<body>
    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="pwa-install-banner" style="display: none;">
        <div class="pwa-banner-content">
            <div class="pwa-banner-info">
                <h3>ðŸ“± Install Peeble App</h3>
                <p>Get better NFC performance and offline access</p>
            </div>
            <div class="pwa-banner-actions">
                <button id="pwa-install-btn" class="btn btn-small">Install</button>
                <button id="pwa-dismiss-btn" class="btn btn-secondary btn-small">Later</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="logo">
            <h1>ðŸª¨ Peeble</h1>
            <p>Voice messages across languages & distances</p>
        </div>

        <!-- PWA Status Indicator -->
        <div id="pwa-status" class="pwa-status" style="display: none;">
            <span id="pwa-status-text">ðŸ“± PWA Status: Loading...</span>
        </div>

        <!-- Pinata API Setup - This section will be hidden once credentials are saved -->
        <div class="api-setup" id="apiSetup">
            <h3>ðŸ”‘ Pinata IPFS Setup (Testing Only)</h3>
            <div class="api-input">
                <input type="text" id="pinataApiKey" placeholder="Pinata API Key" />
                <input type="password" id="pinataSecret" placeholder="Pinata Secret" />
                <button class="btn btn-small" onclick="window.testPinataConnection()">Test Connection</button>
            </div>
            <p style="font-size: 0.8em; color: #718096; margin-top: 10px;">
                Get free API keys at <a href="https://pinata.cloud" target="_blank">pinata.cloud</a> â†’ API Keys â†’ New Key
                <br><strong>Required permissions:</strong> pinFileToIPFS
            </p>
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #5a67d8;">ðŸ”§ Troubleshooting</summary>
                <div style="margin-top: 10px; font-size: 0.85em; color: #4a5568;">
                    <p><strong>If upload fails:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.4;">
                        <li>Check the debug console below for detailed errors</li>
                        <li>Ensure API key has "pinFileToIPFS" permission</li>
                        <li>Try a shorter recording (file size limits)</li>
                        <li>Check your Pinata account usage/quota</li>
                    </ul>
                </div>
            </details>
        </div>
        
        <!-- NFC Serial number display for debugging -->
        <div id="nfc-serial-display" class="status warning" style="display:none; text-align: center;">
            <strong>Tag Serial:</strong> <span id="serialNumber">N/A</span>
        </div>

        <!-- Debug Console Component -->
        <debug-console></debug-console>

        <!-- Main Peeble App Component - This will render either voice-recorder or message-player -->
        <peeble-app></peeble-app>

        <!-- NFC Handler Component - For actual NFC interactions -->
        <nfc-handler></nfc-handler>
    </div>

    <!-- Load Services -->
    <script type="module" src="services/encryption.js"></script>
    <script type="module" src="services/storage.js"></script>
    <script type="module" src="services/nfc.js"></script>
    <script type="module" src="services/audio.js"></script>
    <script type="module" src="services/utils.js"></script> <!-- Consolidated utilities -->

    <!-- Load Components -->
    <script type="module" src="components/debug-console.js"></script>
    <script type="module" src="components/voice-recorder.js"></script>
    <script type="module" src="components/message-player.js"></script>
    <script type="module" src="components/nfc-handler.js"></script>
    <script type="module" src="components/peeble-app.js"></script>

    <!-- PWA Service Worker Registration -->
    <script>
        // PWA functionality
        let deferredPrompt;
        let isInstalled = false;

        // Check if running in PWA mode
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true ||
                   document.referrer.includes('android-app://');
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('ðŸ”§ PWA: Service Worker registered successfully:', registration.scope);
                    
                    // Update PWA status
                    updatePWAStatus('Service Worker active');
                    
                    // Handle service worker updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available
                                    console.log('ðŸ”„ PWA: New version available');
                                    showUpdateAvailable();
                                }
                            });
                        }
                    });
                    
                } catch (error) {
                    console.error('ðŸ”§ PWA: Service Worker registration failed:', error);
                    updatePWAStatus('Service Worker failed', 'error');
                }
            });

            // Listen for messages from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                const { data } = event;
                
                if (data.type === 'PEEBLE_URL_NAVIGATION') {
                    console.log('ðŸ”’ PWA: Received URL navigation from Service Worker:', data);
                    
                    // Update the current URL without reloading
                    const newUrl = `${window.location.origin}${window.location.pathname}#messageId=${data.messageId}&ipfsHash=${data.ipfsHash}`;
                    history.pushState({}, '', newUrl);
                    
                    // Trigger the state manager to process the new URL
                    if (window.stateManager) {
                        window.stateManager.initializeFromUrl();
                    }
                    
                    // Show notification that we received the URL
                    if (window.debugLog) {
                        window.debugLog(`ðŸ”’ PWA: Navigated to message ${data.messageId} via Service Worker`, 'success');
                    }
                }
            });
        }

        // PWA Install Banner
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ðŸ”§ PWA: Install prompt triggered');
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        // App installed event
        window.addEventListener('appinstalled', () => {
            console.log('ðŸŽ‰ PWA: App installed successfully');
            isInstalled = true;
            hideInstallBanner();
            updatePWAStatus('App installed!', 'success');
            
            // Hide banner after short delay
            setTimeout(() => {
                document.getElementById('pwa-status').style.display = 'none';
            }, 3000);
        });

        // Show install banner
        function showInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner && !isInstalled && !isPWA()) {
                banner.style.display = 'block';
                updatePWAStatus('Install available');
            }
        }

        // Hide install banner
        function hideInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        // Install button click
        document.addEventListener('DOMContentLoaded', () => {
            const installBtn = document.getElementById('pwa-install-btn');
            const dismissBtn = document.getElementById('pwa-dismiss-btn');
            
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        console.log('ðŸ”§ PWA: Showing install prompt');
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        
                        if (outcome === 'accepted') {
                            console.log('ðŸŽ‰ PWA: User accepted install');
                        } else {
                            console.log('âŒ PWA: User dismissed install');
                        }
                        
                        deferredPrompt = null;
                        hideInstallBanner();
                    }
                });
            }
            
            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    hideInstallBanner();
                    // Remember dismissal for this session
                    sessionStorage.setItem('pwa-install-dismissed', 'true');
                });
            }
            
            // Check if should show banner on load
            if (!sessionStorage.getItem('pwa-install-dismissed') && !isPWA()) {
                // Wait a bit before showing banner to let user see the app first
                setTimeout(() => {
                    if (deferredPrompt) {
                        showInstallBanner();
                    }
                }, 3000);
            }
            
            // Update PWA status on load
            if (isPWA()) {
                updatePWAStatus('Running as PWA', 'success');
                setTimeout(() => {
                    document.getElementById('pwa-status').style.display = 'none';
                }, 2000);
            } else {
                updatePWAStatus('Web app mode');
            }
        });

        // Update PWA status display
        function updatePWAStatus(message, type = 'info') {
            const statusDiv = document.getElementById('pwa-status');
            const statusText = document.getElementById('pwa-status-text');
            
            if (statusDiv && statusText) {
                statusText.textContent = `ðŸ“± PWA: ${message}`;
                statusDiv.className = `pwa-status ${type}`;
                statusDiv.style.display = 'block';
            }
        }

        // Show update available notification
        function showUpdateAvailable() {
            updatePWAStatus('Update available - Refresh to apply', 'warning');
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                document.getElementById('pwa-status').style.display = 'none';
            }, 10000);
        }

        // Expose PWA utilities globally for debugging
        window.pwaUtils = {
            isPWA,
            isInstalled: () => isInstalled,
            showInstallBanner,
            hideInstallBanner,
            updateStatus: updatePWAStatus
        };
    </script>

    <!-- Main App Initialization -->
    <script type="module" src="main.js"></script>
</body>
</html>